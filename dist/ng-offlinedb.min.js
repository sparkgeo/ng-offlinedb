angular.module("ng-offlinedb",[]).factory("OfflineDb",["$window","$q","$http",function(e,n,r){"use strict";function t(){var e=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(e+=performance.now());var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?r:3&r|8).toString(16)});return n}var o=1;return function(i,f,u){function l(i){function f(e){if(null==b.remote_url)return null;var n=b.remote_url;return e&&(n+=e+"/"),n}function u(e,n,r){return n=n||!1,r=r||!1,e.$$synced=n,e.$$deleted=r,b.db.transaction("rw?",b.db[c.offlineTableName],function(){return b.db[c.offlineTableName].put(e).then(function(){return e})})}function l(e){return b.db[c.offlineTableName].where(c.offlineDbPrimaryKey).equals(e).delete()}function d(e,t){var o,i=t[c.offlineDbPrimaryKey];if(!a)return console.log("["+e+"] Offline not remotely syncing"),n.when(t);if(!b.remote_url)return console.log("["+e+"] No remote_url defined, not remotely syncing"),n.when(t);if("post"===e){o=f();var d=angular.fromJson(angular.toJson(t));return r.post(o,d).then(function(){return u(t,!0)})}if("put"===e){o=f(i);var s=angular.fromJson(angular.toJson(t));return r.put(o,s).then(function(){return u(t,!0)})}return"delete"===e?(o=f(i),r.delete(o).then(function(){return l(i)})):void 0}function s(){}var b=this,m={};b.remote_url=i,b.db=new Dexie(c.offlineDbName,{autoOpen:!0}),m[c.offlineTableName]=c.offlineDbIndicies,b.db.version(o).stores(m),b.filter=function(e){var n=b.db[c.offlineTableName];return e=e||{},e.$$deleted=!1,n.toArray(function(n){return n.filter(function(n){var r=!0;for(var t in e){if(t in n&&n[t]!==e[t]){r=!1;break}return r}})})},b.get=function(e){return n.when(b.db[c.offlineTableName].get(e,function(e){return e}))},b.create=function(e){var n,r=t();return e[c.offlineDbPrimaryKey]=r,n=angular.extend({},e),n.$$synced=!1,n.$$deleted=!1,u(n).then(function(){return n=angular.extend(new s,n),d("post",n)})},s.prototype.remote_sync=function(){var e="put";return this.$$deleted===!0&&this.$$synced===!1&&(e="delete"),d(e,this)},s.prototype.delete=function(){var e=this;return u(e,!1,!0).then(function(){return e.remote_sync("delete",e)})},s.prototype.update=function(){var e=this,n=e[c.offlineDbPrimaryKey];if(null==n)throw"`"+c.offlineDbPrimaryKey+"` does not exist or not defined";if(e.$$deleted===!0)throw"Record does not exist";return u(e).then(function(){return e.remote_sync("put",e)})},b.db[c.offlineTableName].mapToClass(s,c.offlineDbStructure),e.addEventListener("online",function(){a=!0,b.db[c.offlineTableName].where("$$synced").equals(!1).each(function(e){e.remote_sync()})},!1),e.addEventListener("offline",function(){a=!1})}f&&!f.endsWith("/")&&(f="/");var a=navigator.onLine,c=u||{};if(c.offlineDbName=i,c.offlineTableName=c.offlineTableName||c.offlineDbName,c.offlineDbPrimaryKey=c.offlineDbPrimaryKey||"id",c.offlineDbIndicies=c.offlineDbIndicies||"",c.offlineDbStructure=c.offlineDbStructure||{id:String},c.offlineDbIndicies.indexOf("&"+c.offlineDbPrimaryKey)===-1){var d="&"+c.offlineDbPrimaryKey;c.offlineDbIndicies.trim().length>0&&(d+=","+c.offlineDbIndicies),c.offlineDbIndicies=d}return c.offlineDbStructure.$$synced=Boolean,c.offlineDbStructure.$$deleted=Boolean,new l(f,c)}}]);