angular.module("ng-offlinedb",[]).factory("OfflineDb",["$window","$q","$http",function(e,n,r){"use strict";function t(){var e=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(e+=performance.now());var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?r:3&r|8).toString(16)});return n}var o=1;return function(i,f,u){function l(i){function f(e){if(null==m.remote_url)return null;var n=m.remote_url;return e&&(n+=e+"/"),n}function u(e,n,r){return n=n||!1,r=r||!1,e.$$synced=n,e.$$deleted=r,m.db.transaction("rw?",m.db[c.offlineTableName],function(){return m.db[c.offlineTableName].put(e).then(function(){return e})})}function l(e){return m.db[c.offlineTableName].where(c.offlineDbPrimaryKey).equals(e).delete()}function d(e,t){var o,i=t[c.offlineDbPrimaryKey];if(!a)return console.log("["+e+"] Offline not remotely syncing"),n.when(t);if(!m.remote_url)return console.log("["+e+"] No remote_url defined, not remotely syncing"),n.when(t);if("post"===e){o=f();var d=angular.fromJson(angular.toJson(t));return r.post(o,d).then(function(){return u(t,!0)})}if("put"===e){o=f(i);var s=angular.fromJson(angular.toJson(t));return r.put(o,s).then(function(){return u(t,!0)})}if("delete"===e)return o=f(i),r.delete(o).then(function(){return l(i)});throw e+" not supported"}function s(e,n,r){var t;return r=r||!1,n[c.offlineDbPrimaryKey]=e,t=angular.extend({},n),t.$$synced=!1,t.$$deleted=!1,u(t)}function b(){}var m=this,y={};m.remote_url=i,m.db=new Dexie(c.offlineDbName,{autoOpen:!0}),y[c.offlineTableName]=c.offlineDbIndicies,m.db.version(o).stores(y),m.filter=function(e){var n=m.db[c.offlineTableName];return e=e||{},e.$$deleted=!1,n.toArray(function(n){return n.filter(function(n){var r=!0;for(var t in e){if(t in n&&n[t]!==e[t]){r=!1;break}return r}})})},m.get=function(e){return n.when(m.db[c.offlineTableName].get(e,function(e){return e}))},m.create=function(e){var n=t();return s(n,e).then(function(e){return d("post",angular.extend(new b,e))})},m.addRemoteRecord=function(e){var n=e[c.offlineDbPrimaryKey];if(null==n)throw"Primary key not defined";return m.get(n).then(function(r){if(null==r)return s(n,e,!0)})},m.clear=function(){return m.db[c.offlineTableName].clear()},b.prototype.remote_sync=function(){var e="put";return this.$$deleted===!0&&this.$$synced===!1&&(e="delete"),d(e,this)},b.prototype.delete=function(){var e=this;return u(e,!1,!0).then(function(){return e.remote_sync("delete",e)})},b.prototype.update=function(){var e=this,n=e[c.offlineDbPrimaryKey];if(null==n)throw"`"+c.offlineDbPrimaryKey+"` does not exist or not defined";if(e.$$deleted===!0)throw"Record does not exist";return u(e).then(function(){return e.remote_sync("put",e)})},m.db[c.offlineTableName].mapToClass(b,c.offlineDbStructure),e.addEventListener("online",function(){a=!0,m.db[c.offlineTableName].where("$$synced").equals(!1).each(function(e){e.remote_sync()})},!1),e.addEventListener("offline",function(){a=!1})}f&&!f.endsWith("/")&&(f="/");var a=navigator.onLine,c=u||{};if(c.offlineDbName=i,c.offlineTableName=c.offlineTableName||c.offlineDbName,c.offlineDbPrimaryKey=c.offlineDbPrimaryKey||"id",c.offlineDbIndicies=c.offlineDbIndicies||"",c.offlineDbStructure=c.offlineDbStructure||{id:String},c.offlineDbIndicies.indexOf("&"+c.offlineDbPrimaryKey)===-1){var d="&"+c.offlineDbPrimaryKey;c.offlineDbIndicies.trim().length>0&&(d+=","+c.offlineDbIndicies),c.offlineDbIndicies=d}return c.offlineDbStructure.$$synced=Boolean,c.offlineDbStructure.$$deleted=Boolean,new l(f,c)}}]);