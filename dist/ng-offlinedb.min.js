angular.module("ng-offlinedb").factory("OfflineDb",["$window","$q","$http",function(e,n,t){"use strict";function r(){var e=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(e+=performance.now());var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)});return n}return function(o,i,f){function u(o){function i(e){return s.remote_url+e+"/"}function f(e,n,t){return n=n||!1,t=t||!1,e.$$synced=n,e.$$deleted=t,s.db.transaction("rw?",s.db[a.offlineTableName],function(){return s.db[a.offlineTableName].put(e).then(function(){return e})})}function u(e){return s.db[a.offlineTableName].where(a.offlineDbPrimaryKey).equals(e).delete()}function c(e,r){var o,c=r[a.offlineDbPrimaryKey];if(!l)return console.log("["+e+"] Offline not remotely syncing"),n.when(r);if("post"===e){var d=angular.fromJson(angular.toJson(r));return t.post(s.remote_url,d).then(function(){return f(r,!0)})}if("put"===e){o=i(c);var b=angular.fromJson(angular.toJson(r));return t.put(o,b).then(function(){return f(r,!0)})}return"delete"===e?(o=i(c),t.delete(o).then(function(){return u(c)})):void 0}function d(){}var s=this,b={};s.remote_url=o,s.db=new Dexie(a.offlineDbName,{autoOpen:!0}),b[a.offlineTableName]=a.offlineDbIndicies,s.db.version(a.offlineDbVersion).stores(b),s.query=function(e){var n=s.db[a.offlineTableName];return n.toArray(function(n){return _.filter(n,e)})},s.get=function(e){return n.when(s.db[a.offlineTableName].get(e,function(e){return e}))},s.create=function(e){var o,i=r();return e[a.offlineDbPrimaryKey]=i,o=_.extend({},e),o.$$synced=!1,o.$$deleted=!1,f(o).then(function(){if(!l)return console.log("[CREATE] Offline not remotely syncing"),n.when(o);var e=angular.fromJson(angular.toJson(o));return t.post(s.remote_url,e).then(function(){return f(o,!0)})})},d.prototype.remote_sync=function(){var e="put";return this.$$deleted===!0&&this.$$synced===!1&&(e="delete"),c(e,this)},d.prototype.delete=function(){var e=this;return f(e,!1,!0).then(function(){return e.remote_sync("delete",e)})},d.prototype.update=function(){var e=this,n=e[a.offlineDbPrimaryKey];if(null==n)throw"`"+a.offlineDbPrimaryKey+"` does not exist or not defined";if(e.$$deleted===!0)throw"Record does not exist";return f(e).then(function(){return e.remote_sync("put",e)})},s.db[a.offlineTableName].mapToClass(d,a.offlineDbStructure),e.addEventListener("online",function(){l=!0,s.query({$$synced:!1}).then(function(e){console.log("Starting to sync %s records.",e.length),_.each(e,function(e){e.remote_sync()})})},!1),e.addEventListener("offline",function(){l=!1})}i.endsWith("/")||(i="/");var l=navigator.onLine,a=f||{};if(a.offlineDbName=o,a.offlineTableName=offlineTableName||a.offlineDbName,a.offlineDbVersion=a.offlineDbVersion||1,a.offlineDbPrimaryKey=a.offlineDbPrimaryKey||"id",a.offlineDbIndicies=a.offlineDbIndicies||"",a.offlineDbStructure=a.offlineDbStructure||{id:String},a.offlineDbIndicies.indexOf("&"+a.offlineDbPrimaryKey)===-1){var c="&"+a.offlineDbPrimaryKey;a.offlineDbIndicies.trim().length>0&&(c+=","+a.offlineDbIndicies),a.offlineDbIndicies=c}return a.offlineDbStructure.$$synced=Boolean,a.offlineDbStructure.$$deleted=Boolean,new u(i,a)}}]);